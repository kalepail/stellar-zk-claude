env >> /etc/environment
mkdir -p ${DATA_DIRECTORY:-/workspace}

export RUSTUP_INIT_SKIP_PATH_CHECK=yes
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile default

. "$HOME/.cargo/env"

curl -L https://risczero.com/install | INSTALLER_NO_PROMPT=1 bash

export PATH="$HOME/.risc0/bin:$PATH"
source "/root/.bashrc" 2>/dev/null || true

rzup install || true
rzup install risc0-groth16 || true

cd /workspace/
if [ -d "stellar-zk-claude" ]; then
    cd stellar-zk-claude/
    git fetch && git pull
else
    git clone https://github.com/kalepail/stellar-zk-claude.git
    cd stellar-zk-claude/
fi
git checkout feature/claude-initial-risc0

cd risc0/

apt-get update -qq
DEBIAN_FRONTEND=noninteractive apt-get install -y lsof clang libclang-dev

. "$HOME/.cargo/env"

RUSTFLAGS="-C target-cpu=native" cargo build -F cuda -r --package api-server

kill -9 $(lsof -t -i:8080) 2>/dev/null || true

pip uninstall torch torchvision torchaudio --no-input 2>/dev/null || true
pip cache purge 2>/dev/null || true

mkdir -p --mode=0755 /usr/share/keyrings
curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
echo 'deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main' | tee /etc/apt/sources.list.d/cloudflared.list
apt-get update && apt-get install -y cloudflared

./target/release/api-server &
