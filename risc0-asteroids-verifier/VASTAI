#!/usr/bin/env bash
set -euo pipefail

# ---------------------------------------------------------------------------
# Vast.ai environment setup script
#
# This script prepares a fresh Vast.ai instance for building and running the
# RISC0 Asteroids prover.  It installs system dependencies, clones the repo,
# and installs the Rust + RISC Zero toolchains.  It does NOT compile anything
# or start any services — see the README for build and run instructions.
# ---------------------------------------------------------------------------

REPO_URL="${REPO_URL:-https://github.com/kalepail/stellar-zk-claude.git}"
WORKDIR="${WORKDIR:-/workspace/stellar-zk}"
GIT_REF="${GIT_REF:-main}"
RUST_TOOLCHAIN_VERSION="${RUST_TOOLCHAIN_VERSION:-1.93.0}"
INSTALL_CLOUDFLARED="${INSTALL_CLOUDFLARED:-0}"

# ── 1. System dependencies ────────────────────────────────────────────────

echo "==> Installing system dependencies..."
apt-get update -qq
DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  build-essential \
  ca-certificates \
  clang \
  curl \
  git \
  libclang-dev \
  libssl-dev \
  protobuf-compiler \
  pkg-config
rm -rf /var/lib/apt/lists/*

# ── 2. Clone / update repository ─────────────────────────────────────────

if [ ! -d "${WORKDIR}/.git" ]; then
  echo "==> Cloning ${REPO_URL} → ${WORKDIR}..."
  git clone "${REPO_URL}" "${WORKDIR}"
fi

cd "${WORKDIR}"
git remote set-url origin "${REPO_URL}" || true
git fetch --prune --tags origin

if git rev-parse --verify --quiet "origin/${GIT_REF}^{commit}" >/dev/null; then
  git checkout -B "${GIT_REF}" "origin/${GIT_REF}"
elif git rev-parse --verify --quiet "${GIT_REF}^{commit}" >/dev/null; then
  git checkout --detach "${GIT_REF}"
else
  echo "ERROR: GIT_REF '${GIT_REF}' was not found on origin or locally."
  exit 1
fi

echo "==> Repository ready at ${WORKDIR} ($(git rev-parse --short HEAD))"

# ── 3. Rust toolchain ────────────────────────────────────────────────────

if ! command -v rustup &>/dev/null; then
  echo "==> Installing Rust ${RUST_TOOLCHAIN_VERSION}..."
  export RUSTUP_INIT_SKIP_PATH_CHECK=yes
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | \
    sh -s -- -y --profile default --default-toolchain "${RUST_TOOLCHAIN_VERSION}"
fi

export CARGO_HOME="${CARGO_HOME:-$HOME/.cargo}"
export RUSTUP_HOME="${RUSTUP_HOME:-$HOME/.rustup}"
export PATH="${CARGO_HOME}/bin:${HOME}/.risc0/bin:${PATH}"

echo "==> Rust $(rustc --version)"

# ── 4. RISC Zero toolchain ───────────────────────────────────────────────

if ! command -v r0vm &>/dev/null; then
  echo "==> Installing RISC Zero toolchain..."
  curl -L https://risczero.com/install | INSTALLER_NO_PROMPT=1 bash
  rzup install
  rzup install risc0-groth16 || true
fi

echo "==> RISC Zero toolchain ready"

# ── 5. Cloudflare Tunnel (optional) ──────────────────────────────────────

if [ "${INSTALL_CLOUDFLARED}" = "1" ]; then
  echo "==> Installing cloudflared..."
  mkdir -p --mode=0755 /usr/share/keyrings
  curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | \
    tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
  echo 'deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main' \
    > /etc/apt/sources.list.d/cloudflared.list
  apt-get update -qq
  DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends cloudflared
  rm -rf /var/lib/apt/lists/*
fi

# ── Done ──────────────────────────────────────────────────────────────────

PROVER_DIR="${WORKDIR}/risc0-asteroids-verifier"

cat <<EOF

========================================================================
  Environment setup complete.

  Next steps (from an SSH session):

    cd ${PROVER_DIR}

    # Build (CUDA enabled by default):
    cargo build --locked --release -p api-server

    # Build (CPU only, for testing without GPU):
    cargo build --locked --release -p api-server --no-default-features

    # Quick test run (foreground):
    API_KEY='your-secret' ./target/release/api-server

    # Recommended production mode (supervisord — Vast.ai has no systemd):
    mkdir -p /etc/stellar-zk /var/lib/stellar-zk/prover
    cp deploy/supervisord/risc0-asteroids-api.conf /etc/supervisor/conf.d/
    cp api-server/.env.example /etc/stellar-zk/api-server.env

    # IMPORTANT: Update command and directory paths in the supervisor conf
    # to match your actual clone path (${PROVER_DIR}):
    nano /etc/supervisor/conf.d/risc0-asteroids-api.conf
    nano /etc/stellar-zk/api-server.env   # set API_KEY and other config

    # Cloudflare Tunnel (also supervised for auto-restart):
    cp deploy/supervisord/cloudflared.conf /etc/supervisor/conf.d/
    # For production: edit the conf to use a named tunnel instead of quick-tunnel

    # Load configs (supervisord is already running on Vast.ai images):
    supervisorctl reread && supervisorctl update
    supervisorctl status                   # verify both are running
    tail -f /var/lib/stellar-zk/prover/api-server.log

    # Verify GPU is active:
    curl -s http://127.0.0.1:8080/health | jq '.accelerator'

  See risc0-asteroids-verifier/README.md for full documentation.
========================================================================
EOF
