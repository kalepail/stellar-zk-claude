#!/usr/bin/env bash
set -euo pipefail

REPO_URL="${REPO_URL:-https://github.com/kalepail/stellar-zk-claude.git}"
WORKDIR="${WORKDIR:-/workspace/stellar-zk}"
GIT_REF="${GIT_REF:-feature/super-risc0-asteroids}"
IMAGE="${IMAGE:-asteroids-zk-api:latest}"
CONTAINER_NAME="${CONTAINER_NAME:-asteroids-zk-api}"
ENABLE_CUDA="${ENABLE_CUDA:-1}"
CUDA_DEVEL_IMAGE="${CUDA_DEVEL_IMAGE:-vastai/base-image:cuda-12.9.1-auto@sha256:0d1210a72dcef044bf049b86a56b02dd6df6c8a7b0cdebdf41caf56e02a741ff}"
CUDA_RUNTIME_IMAGE="${CUDA_RUNTIME_IMAGE:-vastai/base-image:cuda-12.9.1-auto@sha256:0d1210a72dcef044bf049b86a56b02dd6df6c8a7b0cdebdf41caf56e02a741ff}"
RUST_TOOLCHAIN_VERSION="${RUST_TOOLCHAIN_VERSION:-1.93.0}"
INSTALL_CLOUDFLARED="${INSTALL_CLOUDFLARED:-0}"
ALLOW_NO_API_KEY="${ALLOW_NO_API_KEY:-0}"
API_KEY="${API_KEY:-}"

apt-get update -qq
DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  ca-certificates \
  curl \
  docker.io \
  git
rm -rf /var/lib/apt/lists/*

if [ ! -d "${WORKDIR}/.git" ]; then
  git clone "${REPO_URL}" "${WORKDIR}"
fi

cd "${WORKDIR}"
git remote set-url origin "${REPO_URL}" || true
git fetch --prune --tags origin

if git rev-parse --verify --quiet "origin/${GIT_REF}^{commit}" >/dev/null; then
  git checkout -B "${GIT_REF}" "origin/${GIT_REF}"
elif git rev-parse --verify --quiet "${GIT_REF}^{commit}" >/dev/null; then
  git checkout --detach "${GIT_REF}"
else
  echo "ERROR: GIT_REF '${GIT_REF}' was not found on origin or locally."
  exit 1
fi

cd "${WORKDIR}/risc0-asteroids-verifier"

export DOCKER_BUILDKIT="${DOCKER_BUILDKIT:-1}"
docker build -f api-server/Dockerfile \
  --build-arg ENABLE_CUDA="${ENABLE_CUDA}" \
  --build-arg CUDA_DEVEL_IMAGE="${CUDA_DEVEL_IMAGE}" \
  --build-arg CUDA_RUNTIME_IMAGE="${CUDA_RUNTIME_IMAGE}" \
  --build-arg RUST_TOOLCHAIN_VERSION="${RUST_TOOLCHAIN_VERSION}" \
  -t "${IMAGE}" .

docker rm -f "${CONTAINER_NAME}" >/dev/null 2>&1 || true

if [ -z "${API_KEY}" ] && [ "${ALLOW_NO_API_KEY}" != "1" ]; then
  echo "ERROR: API_KEY is required by default."
  echo "Set API_KEY=... before running this script, or set ALLOW_NO_API_KEY=1 for local-only testing."
  exit 1
fi

run_args=(
  -d
  --name "${CONTAINER_NAME}"
  --restart unless-stopped
  -p 8080:8080
  --env-file api-server/.env.example
  -e RISC0_DEV_MODE=0
)

if [ "${ENABLE_CUDA}" = "1" ]; then
  run_args+=(--gpus all)
fi

if [ -n "${API_KEY}" ]; then
  run_args+=(-e "API_KEY=${API_KEY}")
fi

docker run "${run_args[@]}" "${IMAGE}"

if [ "${INSTALL_CLOUDFLARED}" = "1" ]; then
  mkdir -p --mode=0755 /usr/share/keyrings
  curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | \
    tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
  echo 'deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main' \
    > /etc/apt/sources.list.d/cloudflared.list
  apt-get update -qq
  DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends cloudflared
  rm -rf /var/lib/apt/lists/*
fi

echo "Waiting for API health check..."
for attempt in $(seq 1 30); do
  if curl -fsS http://127.0.0.1:8080/health >/dev/null; then
    echo "API healthy on :8080"
    break
  fi
  sleep 2
  if [ "${attempt}" -eq 30 ]; then
    echo "ERROR: API failed health checks after 60s."
    docker logs --tail 100 "${CONTAINER_NAME}" || true
    exit 1
  fi
done

echo "Next steps:"
echo "1) Keep Cloudflare Access service tokens enabled at the edge."
echo "2) If needed on this host: cloudflared tunnel --url http://127.0.0.1:8080"
echo "3) Send requests with x-api-key or Authorization: Bearer."
